name: GeoJob-Sentinel Auto Scan

on:
  schedule:
    # Run every 6 hours (adjust as needed)
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  scan-jobs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create config.yaml from secrets
        run: |
          cat > config.yaml << EOF
          database:
            path: "geojob_sentinel.db"
          
          discord:
            webhook_url: "${{ secrets.DISCORD_WEBHOOK_URL }}"
          
          serper:
            api_key: "${{ secrets.SERPER_API_KEY }}"
            custom_dorks:
              - 'site:myworkdayjobs.com "GIS Specialist" OR "GIS Analyst" -senior -lead after:2025-01-01'
              - 'site:myworkdayjobs.com "Geospatial Analyst" -senior -manager after:2025-01-01'
              - 'site:trimble.wd1.myworkdayjobs.com "GIS" -senior -lead'
              - 'site:hexagon.wd5.myworkdayjobs.com "GIS" OR "Geospatial" -senior'
              - 'site:precisely.wd1.myworkdayjobs.com "GIS" -senior'
              - 'site:job-boards.greenhouse.io "GIS Specialist" after:2025-01-01'
              - 'site:governmentjobs.com "GIS" OR "Geospatial" -senior -lead'
              - 'site:usajobs.gov "GIS Specialist" OR "GIS Analyst" -senior'
              - 'site:edu "GIS Analyst" OR "GIS Specialist" inurl:careers -faculty -professor'
              - 'site:idealist.org "GIS" OR "Geospatial"'
              - 'site:linkedin.com/jobs "GIS" "Easy Apply" after:2025-01-01 -senior'
              - 'site:reddit.com/r/gis "hiring" OR "job opening" after:2025-01-01'
          
          ats:
            greenhouse_slugs:
              - "esri"
              - "planetlabs"
              - "onxmaps"
              - "ardentmc"
              - "apexcompanies"
              - "geotab"
              - "blastpoint"
              - "aurorasolar"
              - "dewberry"
              - "langan"
              - "mbakerintl"
            lever_slugs:
              - "mapbox"
              - "carto"
              - "foursquare"
              - "nearmap"
              - "regrowagriculture"
          
          discovery:
            enabled: true
            search_greenhouse: true
            search_lever: true
          
          filters:
            required_keywords:
              - "gis"
              - "geospatial"
              - "spatial"
              - "mapping"
            negative_keywords:
              - "senior"
              - "sr."
              - "sr "
              - "iii"
              - "iv"
              - "lead"
              - "manager"
              - "director"
              - "principal"
              - "chief"
              - "head of"
              - "vp"
              - "vice president"
              - "executive"
              - "architect"
          
          logging:
            level: "INFO"
            file: "geojob_sentinel.log"
          EOF
      
      - name: Restore database from cache
        uses: actions/cache@v4
        with:
          path: geojob_sentinel.db
          key: geojob-db-${{ github.run_number }}
          restore-keys: |
            geojob-db-
      
      - name: Run GeoJob-Sentinel
        run: python geojob_sentinel.py
      
      - name: Upload log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-logs
          path: geojob_sentinel.log
          retention-days: 7
      
      - name: Save database to cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: geojob_sentinel.db
          key: geojob-db-${{ github.run_number }}
